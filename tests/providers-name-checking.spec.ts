import { ApolloDriver, ApolloDriverConfig } from "@nestjs/apollo";
import { Test } from "@nestjs/testing";
import { Resolver, Query } from "@kasi-labs/type-graphql";
import fs from "fs/promises";
import path from "path";

import { TypeGraphQLModule } from "../src/typegraphql.module";

describe("Providers name checking", () => {
  afterAll(async () => {
    return fs.unlink(path.join(__dirname, "../schema.gql"));
  });

  @Resolver()
  class HelloResolver {
    @Query(() => String)
    async hello(): Promise<String> {
      return "Hello";
    }
  }

  @Resolver()
  class WorldResolver {
    @Query(() => String)
    async world(): Promise<String> {
      return "World!";
    }
  }

  it("should consider providers with Symbol names", async () => {
    const module = await Test.createTestingModule({
      imports: [
        TypeGraphQLModule.forRoot<ApolloDriverConfig>({
          emitSchemaFile: true,
          driver: ApolloDriver,
        }),
      ],
      providers: [
        HelloResolver,
        WorldResolver,
        {
          provide: Symbol(`SOME_DESCRIPTION`),
          useValue: { some: "options" },
        },
      ],
    }).compile();

    const generatedSchema = await fs.readFile(
      path.join(__dirname, "../schema.gql"),
      "utf-8",
    );

    expect(generatedSchema).toMatchInlineSnapshot(`
      "# -----------------------------------------------
      # !!! THIS FILE WAS GENERATED BY TYPE-GRAPHQL !!!
      # !!!   DO NOT MODIFY THIS FILE BY YOURSELF   !!!
      # -----------------------------------------------

      type Query {
        hello: String!
        world: String!
      }
      "
    `);

    module.close();
  });
});
